@using LibraryReporter.Models.LibraryReport
@using LibraryReporter.Services
@model List<InLibraryBookReportViewModel>
@inject AuthService authService
@inject UserService userService


<div class="tableBody">

    <div class="search-section">
        <form method="post" action="/LibraryReport/SearchInLibraryBookReport" class="search-form">
            <input type="text" name="name" placeholder="Введите название книги" class="search-input" id="BookName" />
            <input type="text" name="author" placeholder="Введите автора книги" class="search-input" id="Author" />
            <input type="text" name="publisher" placeholder="Введите издателя" class="search-input" id="Publisher" />
            <input type="text" name="barcode" placeholder="Введите штрихкод" class="search-input" id="Barcode" />
            <button type="submit" class="search-button">Найти</button>
        </form>
    </div>
    <div class="creation-order">
        <a class="text-neutral-950 hover:text-orange-500 py-2 px-4 rounded-md bg-orange-200" onclick="createReport()">Создать отчет</a>
    </div>
    <table class="tableBook">
        <thead>
            <tr>
                <th>Название книги</th>
                <th>Автор</th>
                <th>Издатель</th>
                <th>Штрихкод</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var book in Model)
            {
                <tr>
                    <td>@book.BookName</td>
                    <td>@book.Author</td>
                    <td>@book.Publisher</td>
                    <td>@book.Barcode</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function createReport() {
        // Получаем текущую дату
        const today = new Date();
        const formattedDate = today.toLocaleDateString('ru-RU', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        }).replace(/\./g, '-'); // Форматируем дату в формате "20-04-2025"

        // Получаем ViewModel из Razor в формате JSON
        const data = @Html.Raw(Json.Serialize(Model));

        // Отправляем запрос на сервер
        fetch('/LibraryReport/CreateReportForInLibraryBooks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Отчет_Книги_В_Библиотеке_${formattedDate}.docx`; // Добавляем дату в название файла
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => console.error('Ошибка при создании отчета:', error));
    }
</script>